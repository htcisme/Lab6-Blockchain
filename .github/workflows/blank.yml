name: Slither Analysis

on:
  push:
    branches: ["main"]

jobs:
  slither:
    name: Run Slither Static Analysis
    runs-on: ubuntu-latest

    steps:
      # Lấy source code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Cài Python (Slither cần Python 3.x)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Cài Slither & solc-select
      - name: Install Slither
        run: |
          pip install slither-analyzer solc-select

      # Cài đặt phiên bản solc ổn định
      - name: Install solc stable version
        run: |
          solc-select install 0.8.20
          solc-select use 0.8.20
          solc --version

      # Nếu dùng npm (Hardhat/Truffle)
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then npm install; fi

      # Chạy Slither
      - name: Run Slither
        run: |
          slither . --detect-invariants --json slither-report.json

      # Fail workflow nếu có lỗi High Severity
      - name: Fail on High Severity issues
        run: |
          if grep -q '"severity": "High"' slither-report.json; then
            echo "❌ High severity issues detected!"
            exit 1
          else
            echo "✅ No High severity issues."
          fi

      # Upload báo cáo artifact
      - name: Upload Slither Report
        uses: actions/upload-artifact@v3
        with:
          name: slither-report
          path: slither-report.json
